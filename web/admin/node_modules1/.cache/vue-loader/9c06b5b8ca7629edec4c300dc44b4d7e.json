{"remainingRequest":"/Users/jimmy_c/go/src/awesomeProject3/web/admin/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/jimmy_c/go/src/awesomeProject3/web/admin/src/components/page/edit/Index.vue?vue&type=style&index=0&id=3ec02af0&scoped=true&lang=css&","dependencies":[{"path":"/Users/jimmy_c/go/src/awesomeProject3/web/admin/src/components/page/edit/Index.vue","mtime":1623895910881},{"path":"/Users/jimmy_c/go/src/awesomeProject3/web/admin/node_modules/@vue/cli-service/node_modules/css-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/jimmy_c/go/src/awesomeProject3/web/admin/node_modules/@vue/cli-service/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":499162500000},{"path":"/Users/jimmy_c/go/src/awesomeProject3/web/admin/node_modules/@vue/cli-service/node_modules/postcss-loader/src/index.js","mtime":499162500000},{"path":"/Users/jimmy_c/go/src/awesomeProject3/web/admin/node_modules/@vue/cli-service/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/jimmy_c/go/src/awesomeProject3/web/admin/node_modules/@vue/cli-service/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgouY29udGFpbmVyLW5hcnJvd3sKICBtYXJnaW46IDAgYXV0bzsKICBtYXgtd2lkdGg6IDkwJTsKfQoubWFzdGhlYWR7CiAgd2lkdGg6IDEwMCU7CiAgbWFyZ2luLXRvcDogNXB4Owp9Ci5jYXR7CiAgd2lkdGg6IDE4MHB4Owp9Ci5udW17CiAgd2lkdGg6IDYwcHg7Cn0KLmxhbmd7CiAgd2lkdGg6IDEyMHB4Owp9Ci5mdW4tYnRuLWdyb3VwewogIG1hcmdpbi10b3A6IDE1cHg7CiAgbWFyZ2luLWJvdHRvbTogMTVweDsKfQo="},{"version":3,"sources":["Index.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Index.vue","sourceRoot":"src/components/page/edit","sourcesContent":["<template>\n  <div class=\"hello\"\n   @keydown.ctrl.83.prevent=\"save\"\n    @keydown.meta.83.prevent=\"save\">\n    <Header> </Header>\n\n    <el-container class=\"container-narrow\">\n\n      <el-row class=\"masthead\">\n        <el-form :inline=\"true\"   class=\"demo-form-inline\" size=\"small\">\n          <el-form-item :label=\"$t('title')+' : '\">\n            <el-input  placeholder=\"\" v-model=\"title\"></el-input>\n          </el-form-item>\n          <el-form-item :label=\"$t('lang_setting')+' : '\">\n                <el-select  v-model=\"cid\" :placeholder=\"$t('lang_choose')\" class=\"lang\" @change=\"selectCatalog\">\n                <el-option\n                v-for=\"itemlang in belong_to_lang\"\n                :key=\"itemlang.id\"\n                :label=\"itemlang.name\"\n                :value=\"itemlang.id\">\n               </el-option>\n              </el-select>\n            </el-form-item>\n          <el-form-item :label=\"$t('catalog') + ' : '\">\n            <el-select\n              :placeholder=\"$t('optional')\"\n              class=\"cat\"\n              v-model=\"cat_id\"\n              v-if=\"belong_to_catalogs\"\n            >\n             <el-option\n                v-for=\"cat in belong_to_catalogs\"\n                :key=\"cat.cat_name\"\n                :label=\"cat.cat_name\"\n                :value=\"cat.cat_id\"\n              ></el-option>\n            </el-select>\n          </el-form-item>\n            <el-form-item label>\n            <el-button type=\"text\" @click=\"ShowSortPage\">{{\n              $t('sort_pages')\n            }}</el-button>\n          </el-form-item>\n          <el-form-item label>\n            <el-button type=\"text\" @click=\"ShowHistoryVersion\">{{\n              $t('history_version')\n            }}</el-button>\n          </el-form-item>\n          <el-form-item class=\"pull-right\">\n              <el-dropdown  @command=\"dropdown_callback\" split-button type=\"primary\" size=\"medium\" trigger=\"click\" @click=\"save\" title=\"Ctrl + S\">\n                <span id=\"save-page\">{{ $t('save') }}</span>\n                <el-dropdown-menu slot=\"dropdown\">\n                  <el-dropdown-item :command=\"save_to_template\">{{$t('save_to_templ')}}</el-dropdown-item>\n                  <el-tooltip\n                  class=\"item\"\n                  effect=\"dark\"\n                  :content=\"$t('lock_edit_tips')\"\n                  placement=\"left\"\n                >\n                  <el-dropdown-item v-if=\"!isLock\" :command=\"setLock\">{{\n                    $t('lock_edit')\n                  }}</el-dropdown-item>\n                </el-tooltip>\n                <el-dropdown-item v-if=\"isLock\" :command=\"unlock\">{{\n                  $t('cacel_lock')\n                }}</el-dropdown-item>\n                  <!-- <el-dropdown-item>保存前添加注释</el-dropdown-item> -->\n                </el-dropdown-menu>\n              </el-dropdown>\n            <el-button type=\"\" size=\"medium\" @click=\"goback\">{{$t('cancel')}}</el-button>\n          </el-form-item>\n        </el-form>\n\n        <el-row class=\"fun-btn-group\">\n          <el-button type=\"\" size=\"medium\" @click=\"insert_api_template\">{{$t('insert_apidoc_template')}}</el-button>\n          <el-button type=\"\" size=\"medium\" @click=\"insert_database_template\">{{$t('insert_database_doc_template')}}</el-button>\n          <el-button type=\"\" size=\"medium\" @click.native=\"ShowTemplateList\">{{$t('more_templ')}}</el-button>\n            <el-dropdown split-button type=\"\" style=\"margin-left:100px;\" size=\"medium\" trigger=\"hover\" >\n              {{$t('json_tools')}}\n              <el-dropdown-menu slot=\"dropdown\">\n                <el-dropdown-item @click.native=\"ShowJsonToTable\">{{$t('json_to_table')}}</el-dropdown-item>\n                <el-dropdown-item @click.native=\"ShowJsonBeautify\">{{$t('beautify_json')}}</el-dropdown-item>\n                <el-dropdown-item @click.native=\"ShowPasteTable\">{{$t('paste_insert_table')}}</el-dropdown-item>\n              </el-dropdown-menu>\n            </el-dropdown>\n          <el-button type=\"\" size=\"medium\" @click=\"ShowRunApi\">{{$t('http_test_api')}}</el-button>\n          <el-badge :value=\"attachment_count\" class=\"item\">\n            <el-button type size=\"medium\" @click=\"ShowAttachment\">{{$t('attachment')}}</el-button>\n          </el-badge>\n        </el-row>\n\n        <Editormd v-bind:content=\"content\" v-if=\"content\" ref=\"Editormd\"  type=\"editor\" ></Editormd>\n\n      </el-row>\n\n        <!-- 更多模板 -->\n        <TemplateList :callback=\"insertValue\" ref=\"TemplateList\"></TemplateList>\n\n        <!-- 历史版本 -->\n        <HistoryVersion :callback=\"insertValue\" ref=\"HistoryVersion\"></HistoryVersion>\n\n        <!-- Json转表格 组件 -->\n        <JsonToTable   :callback=\"insertValue\" ref=\"JsonToTable\" ></JsonToTable>\n\n        <!-- Json格式化 -->\n        <JsonBeautify :callback=\"insertValue\" ref=\"JsonBeautify\"></JsonBeautify>\n\n        <!-- 附件列表 -->\n      <AttachmentList\n        :callback=\"insertValue\"\n        :item_id=\"item_id\"\n        :manage=\"true\"\n        :page_id=\"page_id\"\n        ref=\"AttachmentList\"\n      ></AttachmentList>\n       <!-- 粘贴插入表格 -->\n      <PasteTable\n        :callback=\"insertValue\"\n        :item_id=\"item_id\"\n        :manage=\"true\"\n        :page_id=\"page_id\"\n        ref=\"PasteTable\"\n      ></PasteTable>\n\n      <!-- 页面排序 -->\n      <SortPage\n        :callback=\"insertValue\"\n        :belong_to_catalogs=\"belong_to_catalogs\"\n        :item_id=\"item_id\"\n        :page_id=\"page_id\"\n        :cat_id=\"cat_id\"\n        ref=\"SortPage\"\n      ></SortPage>\n      </el-container>\n    <Footer> </Footer>\n    <div class=\"\"></div>\n<!-- 模板存放的地方 -->\n<div id=\"api-doc-templ\"  ref=\"api_doc_templ\" style=\"display:none\">\n\n**简要描述：**\n\n- 用户注册接口\n\n**请求URL：**\n- ` http://xx.com/api/user/register `\n\n**请求方式：**\n- POST\n\n**参数：**\n\n|参数名|必选|类型|说明|\n|:----    |:---|:----- |-----   |\n|username |是  |string |用户名   |\n|password |是  |string | 密码    |\n|name     |否  |string | 昵称    |\n\n **返回示例**\n\n```\n  {\n    \"status\": 0,\n    \"data\": {\n      \"uid\": \"1\",\n      \"username\": \"12154545\",\n      \"name\": \"吴系挂\",\n      \"groupid\": 2 ,\n      \"reg_time\": \"1436864169\",\n      \"last_login_time\": \"0\",\n    }\n  }\n```\n\n **返回参数说明**\n\n|参数名|类型|说明|\n|:-----  |:-----|-----                           |\n|groupid |int   |用户组id，1：超级管理员；2：普通用户  |\n\n **备注**\n\n- 更多返回错误代码请看首页的错误代码描述\n\n</div>\n<div id=\"database-doc-templ\" ref=\"database_doc_templ\" style=\"display:none\">\n\n-  用户表，储存用户信息\n\n|字段|类型|空|默认|注释|\n|:----    |:-------    |:--- |-- -|------      |\n|uid    |int(10)     |否 |  |             |\n|username |varchar(20) |否 |    |   用户名  |\n|password |varchar(50) |否   |    |   密码    |\n|name     |varchar(15) |是   |    |    昵称     |\n|reg_time |int(11)     |否   | 0  |   注册时间  |\n\n- 备注：无\n\n</div>\n  </div>\n</template>\n\n<style scoped>\n  .container-narrow{\n    margin: 0 auto;\n    max-width: 90%;\n  }\n  .masthead{\n    width: 100%;\n    margin-top: 5px;\n  }\n  .cat{\n    width: 180px;\n  }\n  .num{\n    width: 60px;\n  }\n  .lang{\n    width: 120px;\n  }\n  .fun-btn-group{\n    margin-top: 15px;\n    margin-bottom: 15px;\n  }\n</style>\n\n<script>\nimport Editormd from '@/components/common/Editormd'\nimport JsonToTable from '@/components/common/JsonToTable'\nimport JsonBeautify from '@/components/common/JsonBeautify'\nimport TemplateList from '@/components/page/edit/TemplateList'\nimport HistoryVersion from '@/components/page/edit/HistoryVersion'\nimport AttachmentList from '@/components/page/edit/AttachmentList'\nimport PasteTable from '@/components/page/edit/PasteTable'\nimport SortPage from '@/components/page/edit/SortPage'\nimport { rederPageContent } from '@/models/page'\nimport {\n  apiTemplateZh,\n  databaseTemplateZh,\n  apiTemplateEn,\n  databaseTemplateEn\n} from '@/models/template'\n// var $s = require('scriptjs')\nvar $ = require('jquery')\n\nexport default {\n\n  data () {\n    return {\n      currentDate: new Date(),\n      itemList: {},\n      content: '',\n      title: '',\n      item_id: 0,\n      s_number: '',\n      page_id: '',\n      cid: '',\n      name: '',\n      cat_id: 0,\n      copy_page_id: '',\n      attachment_count: '',\n      catalogs: [],\n      isLock: 0,\n      intervalId: 0,\n      saving: false,\n      lang: '',\n      langs: [],\n      lang_array:[],\n      infoForm: []\n    }\n  },\n  computed: {\n    // 新建/编辑目录时供用户选择的上级目录列表\n    belong_to_catalogs: function () {\n      if (!this.catalogs || this.catalogs.length <= 0) {\n        return []\n      }\n      var Info = this.catalogs.slice(0)\n      var cat_array = []\n      // 这个函数将递归\n      var rename = function (catalog, p_cat_name) {\n        if (catalog.length > 0) {\n          for (var j = 0; j < catalog.length; j++) {\n            var cat_name = p_cat_name + ' / ' + catalog[j].cat_name\n            cat_array.push({\n              cat_id: catalog[j].cat_id,\n              cat_name: cat_name\n            })\n            if (catalog[j].sub && catalog[j].sub.length > 0) {\n              rename(catalog[j].sub, cat_name)\n            }\n          }\n        }\n      }\n      for (var i = 0; i < Info.length; i++) {\n        cat_array.push(Info[i])\n        if (Info[i].sub != null) {\n          rename(Info[i].sub, Info[i].cat_name)\n        }\n      }\n      var no_cat = { cat_id: 0, cat_name: this.$t('none') }\n      cat_array.push(no_cat)\n      return cat_array\n    },\n    belong_to_lang: function () {\n      var that = this\n      console.log(that.infoForm.lang_list)\n      if (that.infoForm.lang_list === undefined){\n              return []\n            }\n            var langInfo =that.infoForm.lang_list.split(',')\n            var lang_array = []\n            console.log(langInfo)\n            if (that.lang.length > 0){\n              for (var k=0; k < langInfo.length; k++){\n                if (langInfo[k] === \"\"){\n                  return that.lang\n                }\n              for (var j=0; j < that.lang.length; j++){\n                if (that.lang[j].id === parseInt(langInfo[k])){\n                  lang_array.push({\n                    id: that.lang[j].id,\n                    name: that.lang[j].name,\n                    icon: that.lang[j].icon\n                  })\n                }\n              }\n              }\n            }\n            return lang_array\n\n    }\n  },\n  components: {\n    Editormd,\n    JsonToTable,\n    JsonBeautify,\n    TemplateList,\n    AttachmentList,\n    PasteTable,\n    SortPage,\n    HistoryVersion\n  },\n  methods: {\n    get_lang () {\n      var that = this\n      var url = DocConfig.server + '/lang'\n      var params = new URLSearchParams()\n      that.$http.get(url, params)\n        .then(function (response) {\n          if (response.data.status === 200) {\n            that.langs = response.data.data\n          }\n        })\n        .catch(function (error) {\n          console.log(error)\n        })\n    },\n    get_item_info () {\n      var that = this\n      var url = DocConfig.server + '/item/detail'\n      var params = new URLSearchParams()\n      params.append('item_id', that.$route.params.item_id)\n      that.$http\n        .post(url, params)\n        .then(function (response) {\n          if (response.data.status === 200) {\n            var Info1 = response.data.data\n            that.infoForm = Info1\n            // console.log(that.infoForm.lang_list)\n          } else {\n            that.$alert(response.data.message)\n          }\n        })\n        .catch(function (error) {\n          console.log(error)\n        })\n    },\n    // 获取页面内容\n    get_page_content (page_id) {\n      if (!page_id) {\n        page_id = this.page_id\n      }\n      var that = this\n      var url = DocConfig.server + '/admin/page'\n      var params = new URLSearchParams()\n      params.append('page_id', page_id)\n      that.$http.post(url, params)\n        .then(function (response) {\n          if (response.data.status === 200) {\n            // that.$message.success(\"加载成功\");\n            that.content = rederPageContent(response.data.data.pagecontent)\n            setTimeout(function () {\n              that.insertValue(that.content, 1)\n              document.body.scrollTop = document.documentElement.scrollTop = 0 // 回到顶部\n            }, 500)\n            setTimeout(function () {\n              // 如果长度大于3000,则关闭预览\n              if (that.content.length > 3000) {\n                that.editor_unwatch()\n              } else {\n                that.editor_watch()\n              }\n              that.draft()\n            }, 1000)\n            that.title = response.data.data.pagetitle\n            that.item_id = response.data.data.itemid\n            that.s_number = response.data.data.snumber\n            that.cid = response.data.data.cid\n          } else {\n            that.$alert(response.data.message)\n          }\n        })\n        .catch(function (error) {\n          console.log(error)\n        })\n    },\n    get_catalog (item_id, value) {\n      var that = this\n      var url = DocConfig.server + '/catListGroup'\n      var params = new URLSearchParams()\n      params.append('item_id', item_id)\n      params.append('cid', value)\n      that.$http\n        .post(url, params)\n        .then(function (response) {\n          if (response.data.status === 200) {\n            var Info = response.data.data\n            that.catalogs = Info\n\n            that.get_default_cat()\n          } else {\n            that.$message(response.data.message)\n          }\n        })\n        .catch(function (error) {\n          console.log(error)\n        })\n    },\n    // 获取默认该选中的目录\n    get_default_cat () {\n      var that = this\n      var url = DocConfig.server + '/getDefaultCat'\n      var params = new URLSearchParams()\n      params.append('page_id', this.$route.params.page_id)\n      params.append('item_id', that.$route.params.item_id)\n      params.append('copy_page_id', this.copy_page_id)\n      that.$http.post(url, params)\n        .then(function (response) {\n          if (response.data.status === 200) {\n            // that.$message.success(\"加载成功\")\n            var json = response.data.data\n            that.cat_id = json\n          } else {\n            that.$alert(response.data.message)\n          }\n        })\n    },\n    // 根据语言选择目录\n    selectCatalog () {\n      var that = this\n      that.get_catalog(this.$route.params.item_id, this.cid)\n    },\n    // 插入数据到编辑器中。插入到光标处。如果参数is_cover为真，则清空后再插入(即覆盖)。\n    insertValue (value, is_cover) {\n      if (value) {\n        const childRef = this.$refs.Editormd // 获取子组件\n        if (is_cover) {\n          // 清空\n          childRef.clear()\n        };\n        childRef.insertValue(value) // 调用子组件的方法\n      };\n    },\n    // 插入api模板\n    insert_api_template () {\n      var val\n      if (this.$cookies.get('lng') === 'ZH_CN') {\n        val = apiTemplateZh\n      } else {\n        val = apiTemplateEn\n      }\n      this.insertValue(val)\n    },\n    // 插入数据字典模板\n    insert_database_template () {\n      var val\n      if (this.$cookies.get('lng') === 'ZH_CN') {\n        val = databaseTemplateZh\n      } else {\n        val = databaseTemplateEn\n      }\n      this.insertValue(val)\n    },\n    editor_unwatch () {\n      const childRef = this.$refs.Editormd // 获取子组件\n      childRef.editor_unwatch()\n      if (sessionStorage.getItem('page_id_unwatch_' + this.page_id)) {\n      } else {\n        this.$message(this.$t('long_page_tips'))\n        sessionStorage.setItem('page_id_unwatch_' + this.page_id, 1)\n      }\n    },\n    editor_watch () {\n      const childRef = this.$refs.Editormd // 获取子组件\n      childRef.editor_watch()\n    },\n    // json转参数表格\n    ShowJsonToTable () {\n      const childRef = this.$refs.JsonToTable // 获取子组件\n      childRef.dialogFormVisible = true\n    },\n    // json格式化\n    ShowJsonBeautify () {\n      const childRef = this.$refs.JsonBeautify // 获取子组件\n      childRef.dialogFormVisible = true\n    },\n    ShowRunApi () {\n      window.open('http://runapi.doc.cc/')\n    },\n    // 更多模板、模板列表\n    ShowTemplateList () {\n      const childRef = this.$refs.TemplateList // 获取子组件\n      childRef.show()\n    },\n    ShowPasteTable () {\n      const childRef = this.$refs.PasteTable // 获取子组件\n      childRef.dialogFormVisible = true\n    },\n    // 展示历史版本\n    ShowHistoryVersion () {\n      const childRef = this.$refs.HistoryVersion // 获取子组件\n      childRef.show()\n    },\n    // 展示页面排序\n    ShowSortPage () {\n      this.save(() => {\n        const childRef = this.$refs.SortPage // 获取子组件\n        childRef.show()\n      })\n    },\n    save (callback) {\n      var that = this\n      if (this.saving) {\n        return false\n      }\n      this.saving = true\n      var loading = that.$loading()\n      const childRef = this.$refs.Editormd\n      var content = childRef.getMarkdown()\n      var cat_id = this.cat_id\n      var item_id = that.$route.params.item_id\n      var page_id = that.$route.params.page_id\n      var url = DocConfig.server + '/page/save'\n      var params = new URLSearchParams()\n      params.append('page_id', page_id)\n      params.append('item_id', item_id)\n      params.append('s_number', that.s_number)\n      params.append('page_title', that.title)\n      params.append('cat_id', cat_id)\n      params.append('cid', this.cid)\n      params.append('page_content', encodeURIComponent(content))\n      params.append('is_urlencode', 1)\n      that.$http.post(url, params)\n        .then(function (response) {\n          loading.close()\n          that.saving = false\n          if (response.data.status === 200) {\n            if (typeof callback === 'function') {\n              callback()\n            } else {\n              // that.$message.success(\"加载成功\")\n              // localStorage.removeItem('page_content')\n              // that.$router.push({ path: '/' + item_id, query: { page_id: response.data.data.page_id } })\n              that.$message({\n                showClose: true,\n                message: that.$t('save_success'),\n                type: 'success'\n              })\n            }\n            that.deleteDraft()\n            if (page_id <= 0) {\n              that.$router.push({\n                path: '/page/edit/' + item_id + '/' + response.data.data.ID\n              })\n              that.page_id = response.data.data.ID\n            }\n          } else {\n            that.$alert(response.data.message)\n          }\n        })\n      // 设置一个最长关闭时间\n      setTimeout(() => {\n        loading.close()\n        that.saving = false\n      }, 20000)\n    },\n    goback () {\n      var url = '/' + this.$route.params.item_id\n      this.$router.push({ path: url, query: { page_id: this.$route.params.page_id } })\n    },\n    dropdown_callback (data) {\n      if (data) {\n        data()\n      }\n    },\n    // 另存为模板\n    save_to_template () {\n      var that = this\n      const childRef = this.$refs.Editormd\n      var content = childRef.getMarkdown()\n      this.$prompt(that.$t('save_templ_title'), ' ', {\n      }).then(function (data) {\n        var url = DocConfig.server + '/template/save'\n        var params = new URLSearchParams()\n        params.append('template_title', data.value)\n        params.append('template_content', content)\n        that.$http.post(url, params)\n          .then(function (response) {\n            if (response.data.status === 200) {\n              that.$alert(that.$t('save_templ_text'))\n            } else {\n              that.$alert(response.data.message)\n            }\n          })\n      })\n    },\n    ShowAttachment () {\n      const childRef = this.$refs.AttachmentList // 获取子组件\n      childRef.show()\n    },\n    /** 粘贴上传图片 **/\n    on_paste () {\n      var that = this\n      var url = DocConfig.server + '/upload'\n      document.addEventListener('paste', function (e) {\n        var clipboard = e.clipboardData\n        for (var i = 0, len = clipboard.items.length; i < len; i++) {\n          if (clipboard.items[i].kind === 'file' || clipboard.items[i].type.indexOf('image') > -1) {\n            var imageFile = clipboard.items[i].getAsFile()\n            var form = new FormData()\n            form.append('t', 'ajax-uploadpic')\n            form.append('editormd-image-file', imageFile)\n            var loading = ''\n            var callback = function (type, data) {\n              type = type || 'before'\n              switch (type) {\n                // 开始上传\n                case 'before':\n                  loading = that.$loading()\n                  break\n                  // 服务器返回错误\n                case 'error':\n                  loading.close()\n                  that.$alert('图片上传失败')\n                  break\n                  // 上传成功\n                case 'success':\n                  loading.close()\n                  if (data.success === 1) {\n                    var value = '![](/' + data.url + ')'\n                    that.insertValue(value)\n                  } else {\n                    that.$alert('失败')\n                  }\n                  break\n              }\n              console.log(type)\n            }\n            $.ajax({\n              url: url,\n              type: 'POST',\n              dataType: 'json',\n              data: form,\n              processData: false,\n              contentType: false,\n              beforeSend: function () {\n                // eslint-disable-next-line standard/no-callback-literal\n                callback('before')\n              },\n              error: function () {\n                // eslint-disable-next-line standard/no-callback-literal\n                callback('error')\n              },\n              success: function (data) {\n                // eslint-disable-next-line standard/no-callback-literal\n                callback('success', data)\n              }\n            })\n            e.preventDefault()\n          }\n        }\n      })\n    },\n    // 草稿\n    draft () {\n      var that = this\n      var pkey = 'page_content_' + this.page_id\n      const childRef = this.$refs.Editormd\n      // 定时保存文本内容到localStorage\n      setInterval(() => {\n        var content = childRef.getMarkdown()\n        localStorage.setItem(pkey, content)\n      }, 30 * 1000)\n      // 检测是否有定时保存的内容\n      var page_content = localStorage.getItem(pkey)\n      if (\n        page_content &&\n        page_content.length > 0 &&\n        page_content !== childRef.getMarkdown() &&\n        childRef.getMarkdown() &&\n        childRef.getMarkdown().length > 10\n      ) {\n        localStorage.removeItem(pkey)\n        that\n          .$confirm(that.$t('draft_tips'), '', {\n            showClose: false\n          })\n          .then(() => {\n            that.insertValue(page_content, true)\n            localStorage.removeItem(pkey)\n          })\n          .catch(() => {\n            localStorage.removeItem(pkey)\n          })\n      }\n    },\n    // 遍历删除草稿\n    deleteDraft () {\n      for (var i = 0; i < localStorage.length; i++) {\n        var name = localStorage.key(i)\n        if (name.indexOf('page_content_') > -1) {\n          localStorage.removeItem(name)\n        }\n      }\n    },\n    // 锁定\n    async setLock () {\n      var url = DocConfig.server + '/page/setLock'\n      var formdata = new FormData()\n      formdata.append('page_id', this.page_id)\n      formdata.append('item_id', this.item_id)\n      if (this.page_id > 0) {\n        const { data: res } = await this.$http.post(url, formdata)\n        if (res.status === 200) {\n          this.isLock = 1\n        }\n      }\n    },\n    // 解除锁定\n    async unlock () {\n      if (!this.isLock) {\n        return // 本来处于未锁定中的话，不发起请求\n      }\n      var url = DocConfig.server + '/page/setLock'\n      var formdata = new FormData()\n      formdata.append('page_id', this.page_id)\n      formdata.append('item_id', this.item_id)\n      formdata.append('lock_to', 1000)\n      const { data: res } = await this.$http.post(url, formdata)\n      if (res.status === 200) {\n        this.isLock = 0\n      }\n    },\n    // 如果用户处于锁定状态的话，用心跳保持锁定\n    heartBeatLock () {\n      this.intervalId = setInterval(() => {\n        if (this.isLock) {\n          this.setLock()\n        }\n      }, 3 * 60 * 1000)\n    },\n    // 判断页面是否被锁定编辑\n    async remoteIsLock () {\n      var url = DocConfig.server + '/page/isLock'\n      var formdata = new FormData()\n      formdata.append('page_id', this.page_id)\n      const { data: res } = await this.$http.post(url, formdata)\n      // 判断已经锁定了不\n      if (res.data.lock > 0) {\n        if (res.data.isCurUser > 0) {\n          this.isLock = 1\n        } else {\n          this.$alert(this.$t('locking') + res.data.lockUsername)\n          this.goback()\n        }\n      } else {\n        this.setLock() // 如果没有被别人锁定，则进编辑页面后自己锁定。\n      }\n    },\n    // 由于页面关闭事件无法直接发起异步的ajax请求，所以用浏览器的navigator.sendBeacon来实现\n    unLockOnClose () {\n      let user_token = ''\n      const userinfostr = localStorage.getItem('userinfo')\n      if (userinfostr) {\n        const userinfo = JSON.parse(userinfostr)\n        if (userinfo && userinfo.user_token) {\n          user_token = userinfo.user_token\n        }\n      }\n      const analyticsData = new URLSearchParams({\n        page_id: this.page_id,\n        item_id: this.item_id,\n        lock_to: 1000,\n      })\n      const url = DocConfig.server + '/page/setLock'\n      if ('sendBeacon' in navigator) {\n        navigator.sendBeacon(url, analyticsData)\n      } else {\n        var client = new XMLHttpRequest()\n        client.open('POST', url, false)\n        client.send(analyticsData)\n      }\n    }\n  },\n  mounted () {\n    var that = this\n    this.item_id = this.$route.params.item_id\n    this.page_id = this.$route.params.page_id\n    this.copy_page_id = this.$route.query.copy_page_id ? this.$route.query.copy_page_id : ''\n    if (this.copy_page_id > 0) {\n      this.get_page_content(this.copy_page_id)\n    } else if (this.page_id > 0) {\n      this.get_page_content(this.page_id)\n    } else {\n      this.item_id = this.$route.params.item_id\n      this.content = this.$t('welcome_use_doc')\n    }\n    this.cid = this.itemList.cid\n    this.get_catalog(this.$route.params.item_id)\n    this.get_lang()\n    this.heartBeatLock()\n    this.remoteIsLock()\n    that.on_paste()\n    document.onkeydown = function (e) { // 对整个页面文档监听 其键盘快捷键\n      var keyNum = window.event ? e.keyCode : e.which // 获取被按下的键值\n      if (keyNum === 83 && e.ctrlKey) { // Ctrl +S 为保存\n        that.save()\n        e.preventDefault()\n      }\n    }\n    // document.addEventListener('paste', this.on_paste)\n    // window.addEventListener('beforeunload', this.unLockOnClose)\n  }\n  // beforeDestroy () {\n  //   // 解除对粘贴上传图片的监听\n  //   document.removeEventListener('paste', this.on_paste)\n  //   this.$message.closeAll()\n  //   clearInterval(this.intervalId)\n  //   this.unlock()\n  //   window.removeEventListener('beforeunload', this.unLockOnClose)\n  // }\n}\n</script>\n"]}]}